
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Recap Pesanan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .overflow-x-auto::-webkit-scrollbar { height: 4px; }
        .overflow-x-auto::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-fast { animation: pulse-red 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <header class="gradient-bg text-white py-6 px-4 md:py-8 md:px-6 shadow-lg">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-xl md:text-2xl font-bold">Admin Panel Recap</h1>
                <p class="opacity-80 text-xs md:text-sm">Manajemen & Statistik Pesanan ID Card</p>
            </div>
            <div id="status" class="bg-white/20 px-4 py-2 rounded-full text-[10px] md:text-xs font-mono transition-all duration-500">
                Menghubungkan...
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 md:gap-4 mb-6 md:mb-8">
            <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-blue-100 ring-1 ring-blue-50">
                <p class="text-slate-500 text-[10px] md:text-xs uppercase font-bold tracking-wider mb-1">Total Target</p>
                <h2 id="totalOmset" class="text-lg md:text-xl font-bold text-blue-900 truncate">Rp 0</h2>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-indigo-100 ring-2 ring-indigo-50">
                <p class="text-indigo-500 text-[10px] md:text-xs uppercase font-bold tracking-wider mb-1">Uang Terkumpul</p>
                <h2 id="totalTerkumpul" class="text-lg md:text-2xl font-bold text-indigo-600 truncate">Rp 0</h2>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-slate-500 text-[10px] md:text-xs uppercase font-bold tracking-wider mb-1">Pesanan</p>
                <h2 id="totalOrders" class="text-lg md:text-2xl font-bold text-slate-800">0</h2>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-slate-500 text-[10px] md:text-xs uppercase font-bold tracking-wider mb-1">S/B/L</p>
                <h2 class="text-lg md:text-xl font-bold"><span id="countSatuan" class="text-emerald-500">0</span><span class="text-slate-300 mx-1">/</span><span id="countBundling" class="text-orange-500">0</span><span class="text-slate-300 mx-1">/</span><span id="totalLogistik" class="text-slate-700">0</span></h2>
            </div>
            <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-slate-500 text-[10px] md:text-xs uppercase font-bold tracking-wider mb-1 text-red-500">Duplikat</p>
                <h2 id="duplicateCount" class="text-lg md:text-2xl font-bold text-red-600">0</h2>
            </div>
        </div>

        <div class="mb-6">
            <div class="relative max-w-md">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
                <input type="text" id="searchInput" placeholder="Cari nama siswa..." 
                    class="block w-full pl-10 pr-3 py-2.5 border border-slate-200 rounded-xl leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all shadow-sm">
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto w-full">
                <table class="w-full text-left border-collapse min-w-[900px]">
                    <thead>
                        <tr class="bg-slate-100 border-b border-slate-200 text-slate-600 text-[11px] md:text-sm uppercase tracking-wider">
                            <th class="px-4 md:px-6 py-4 font-semibold text-center w-16">Foto</th>
                            <th class="px-4 md:px-6 py-4 font-semibold">Nama & Waktu</th>
                            <th class="px-4 md:px-6 py-4 font-semibold">Paket & Harga</th>
                            <th class="px-4 md:px-6 py-4 font-semibold">Status Bayar</th>
                            <th class="px-4 md:px-6 py-4 font-semibold text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100 text-xs md:text-sm"></tbody>
                </table>
            </div>
            <div id="emptyState" class="hidden p-10 text-center text-slate-400">
                Data tidak ditemukan.
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCP45uq14jZysxMNf03DwtJlmjEMZXavY0",
            authDomain: "ukib-b4675.firebaseapp.com",
            databaseURL: "https://ukib-b4675-default-rtdb.firebaseio.com",
            projectId: "ukib-b4675",
            appId: "1:221524523430:web:2f4fd0c54cfefa5fb1f767"
        };

        const driveLinks = {
            "X TSM 1": "https://drive.google.com/drive/folders/1Kmw9jtCBk8FK1e_Ypk3uekVLnWKWRy2C",
            "X TSM 2": "https://drive.google.com/drive/folders/1hltKg5XH92mskjeeVrW6Cy98A1A8M2nT",
            "X TSM 3": "https://drive.google.com/drive/folders/1OSn47Db_05rJoGiDO7wqGvQbMBhlRTwc",
            "X TKR 1": "https://drive.google.com/drive/folders/1RbaFr3YBU5zuSUSPUuxY58sOKO_FGKka",
            "X TKR 2": "https://drive.google.com/drive/folders/17eB6pebDDYerUdjKYiLqHLNPKy_Gq5B6",
            "X TKR 3": "https://drive.google.com/drive/folders/1owECYmHBt2GTwpUyNNi2fXxV3H9fyXfe",
            "X DPIB 1": "https://drive.google.com/drive/folders/1WXtMXVJf90Cbsldx0CO24U5ltWtqlv9P",
            "X DPIB 2": "https://drive.google.com/drive/folders/1M9uLkEqFXM_ojFgBrDN0Hw9q-7Dvusz6",
            "X TEI 1": "https://drive.google.com/drive/folders/18hWzCwSql_s9hP-MYxqzx9AtlCuIe_tS",
            "X TEI 2": "https://drive.google.com/drive/folders/1NEKUYAF3Rhx96GovmQa8_QCX2-ssgSLD",
            "X TEI 3": "https://drive.google.com/drive/folders/1c6vcKsIx-PqFdNEYj_NyUKh8A582QNKG",
            "X TEI 4": "https://drive.google.com/drive/folders/1fJibpT3VkcRXFprVIVe56qj9KkzjoD2F",
            "X RPL 1": "https://drive.google.com/drive/folders/1MShb0VfYk44jnWqPgsnH0tay4P_jdfaU",
            "X RPL 2": "https://drive.google.com/drive/folders/1mZWRi7Rg4w2oNzeUzRHk7XS2VXxyxy00",
            "X RPL 3": "https://drive.google.com/drive/folders/1BIedDbUrJig9ULtFi9xlJ-P7DPyg_CJs",
            "X TPTL": "https://drive.google.com/drive/folders/1wk8b0YJh1-f_2U8Q_ZK1dHEkOgNeqiEX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ordersRef = ref(db, 'orders');
        const statusEl = document.getElementById('status');
        const searchInput = document.getElementById('searchInput');

        let rawData = {}; 

        function formatDateTime(waktu) {
            if (!waktu) return "-";
            return waktu.replace(',', '').split(':').slice(0, 2).join(':');
        }

        function formatPhone(num) {
            if(!num) return "";
            let c = num.toString().replace(/\D/g, '');
            return c.startsWith('0') ? '62' + c.slice(1) : c;
        }

        function renderTable(data, filterText = "") {
            const tableBody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');
            tableBody.innerHTML = "";
            
            let stats = { total: 0, satuan: 0, bundling: 0, omset: 0, terkumpul: 0, logistik: 0, duplicates: 0 };
            
            if (!data) {
                emptyState.classList.remove('hidden');
                return;
            }

            const searchLower = filterText.toLowerCase();
            const nameCounts = {};
            Object.values(data).forEach(order => {
                const uniqueKey = `${(order.nama || "").trim().toUpperCase()}_${(order.kelas || "").toUpperCase()}`;
                nameCounts[uniqueKey] = (nameCounts[uniqueKey] || 0) + 1;
            });

            const groupedData = {};
            Object.keys(data).forEach(key => {
                const order = data[key];
                const nama = (order.nama || "").toLowerCase();
                const className = (order.kelas || "Tanpa Kelas").toUpperCase();

                if (nama.includes(searchLower)) {
                    if (!groupedData[className]) groupedData[className] = [];
                    groupedData[className].push({ id: key, ...order });
                }
            });

            const groups = Object.keys(groupedData).sort();
            if (groups.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }

            groups.forEach(className => {
                const classOrders = groupedData[className];
                tableBody.innerHTML += `
                    <tr class="bg-indigo-50/50">
                        <td colspan="5" class="px-4 md:px-6 py-2.5 font-bold text-indigo-800 border-y border-indigo-100 text-[10px] md:text-sm">
                            <div class="flex justify-between">
                                <span>KELAS: ${className}</span>
                                <span class="bg-indigo-200 px-2 py-0.5 rounded text-[10px]">${classOrders.length} Pesanan</span>
                            </div>
                        </td>
                    </tr>
                `;

                classOrders.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(order => {
                    stats.total++;
                    const namaCaps = order.nama ? order.nama.trim().toUpperCase() : "PELANGGAN";
                    const isDouble = nameCounts[`${namaCaps}_${className}`] > 1;
                    if(isDouble) stats.duplicates++;

                    const paket = (order.pilihan_foto || "").toLowerCase();
                    let hargaMaksimal = 0;

                    if (paket === "tipe 1") { hargaMaksimal = 7000; stats.satuan++; } 
                    else if (paket === "tipe 2") {
                        hargaMaksimal = className.includes("TKR 3") ? 10000 : 12000;
                        stats.satuan++; stats.logistik += 1;
                    } 
                    else if (paket.includes("bundling")) {
                        stats.bundling++;
                        if (paket.includes("22k")) { hargaMaksimal = 22000; stats.logistik += 2; }
                        else if (paket.includes("17k")) { hargaMaksimal = 17000; stats.logistik += 1; }
                        else if (paket.includes("12k")) { hargaMaksimal = 12000; }
                    }
                    stats.omset += hargaMaksimal;

                    const bayarSekarang = parseInt(order.paymentAmount || 0);
                    stats.terkumpul += bayarSekarang;

                    const badgeColor = paket.includes('bundling') ? 'bg-purple-100 text-purple-700' : 
                                      (paket === 'tipe 2' ? 'bg-orange-100 text-orange-700' : 'bg-emerald-100 text-emerald-700');
                    
                    const driveLink = driveLinks[className] || "https://drive.google.com/";
                    const waUrl = `https://wa.me/${formatPhone(order.no_hp)}?text=${encodeURIComponent(
  `Halo *${namaCaps}*, kamu belum upload foto sampai saat ini.\n\nSilahkan upload di: ${driveLink}`
)}`;

                    // Generate Dropdown Options
                    let options = `<option value="0">Rp 0 (Belum)</option>`;
                    for(let i = 1000; i <= hargaMaksimal; i += 1000) {
                        options += `<option value="${i}" ${bayarSekarang === i ? 'selected' : ''}>Rp ${i.toLocaleString('id-ID')}</option>`;
                    }

                    const isLunas = bayarSekarang >= hargaMaksimal;
                    const paymentClass = isLunas ? 'bg-emerald-500 text-white border-emerald-600' : 'bg-red-50 text-red-600 border-red-200';

                    tableBody.innerHTML += `
                        <tr class="${isDouble ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-white'} transition border-b border-slate-50">
                            <td class="px-4 md:px-6 py-4 text-center">
                                <input type="checkbox" ${order.isUploaded ? 'checked' : ''} onchange="togglePhotoStatus('${order.id}', this.checked)" 
                                       class="w-5 h-5 rounded border-slate-300 text-indigo-600 cursor-pointer">
                            </td>
                            <td class="px-4 md:px-6 py-4">
                                <div class="font-semibold text-slate-800 flex items-center gap-2">
                                    ${namaCaps}
                                    ${isDouble ? '<span class="px-1.5 py-0.5 rounded text-[8px] bg-red-500 text-white animate-pulse-fast">DOUBLE</span>' : ''}
                                </div>
                                <div class="text-[10px] text-slate-500 font-mono mt-1">ðŸ•’ ${formatDateTime(order.waktu)} | ${order.no_hp || '-'}</div>
                            </td>
                            <td class="px-4 md:px-6 py-4">
                                <span class="px-2 py-1 rounded-md text-[10px] font-bold ${badgeColor} uppercase">${order.pilihan_foto}</span>
                                <div class="text-[10px] font-bold text-slate-400 mt-1 italic font-mono uppercase">Target: Rp ${hargaMaksimal.toLocaleString('id-ID')}</div>
                            </td>
                            <td class="px-4 md:px-6 py-4">
                                <select onchange="updatePaymentAmount('${order.id}', this.value)" 
                                    class="text-[11px] font-bold py-1.5 px-2 rounded-lg border focus:outline-none transition-all cursor-pointer shadow-sm ${paymentClass}">
                                    ${options}
                                </select>
                                ${isLunas ? '<div class="text-[9px] text-emerald-600 font-bold mt-1 ml-1">LUNAS âœ…</div>' : ''}
                            </td>
                            <td class="px-4 md:px-6 py-4 text-center">
                                <div class="flex justify-center gap-3">
                                    <a href="${waUrl}" target="_blank" class="text-green-500 hover:scale-110 transition-transform">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                                    </a>
                                    <button onclick="deleteOrder('${order.id}', '${namaCaps}')" class="text-red-400 hover:text-red-600 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            });

            document.getElementById('totalOrders').innerText = stats.total;
            document.getElementById('countSatuan').innerText = stats.satuan;
            document.getElementById('countBundling').innerText = stats.bundling;
            document.getElementById('totalLogistik').innerText = stats.logistik;
            document.getElementById('duplicateCount').innerText = stats.duplicates;
            document.getElementById('totalOmset').innerText = "Rp " + stats.omset.toLocaleString('id-ID');
            document.getElementById('totalTerkumpul').innerText = "Rp " + stats.terkumpul.toLocaleString('id-ID');
        }

        onValue(ordersRef, (snapshot) => {
            statusEl.innerHTML = "ðŸŸ¢ Terhubung";
            statusEl.classList.replace('bg-white/20', 'bg-emerald-500/40');
            rawData = snapshot.val();
            renderTable(rawData, searchInput.value);
        });

        searchInput.addEventListener('input', (e) => {
            renderTable(rawData, e.target.value);
        });

        window.togglePhotoStatus = (id, status) => {
            update(ref(db, 'orders/' + id), { isUploaded: status });
        };

        window.updatePaymentAmount = (id, amount) => {
            update(ref(db, 'orders/' + id), { paymentAmount: parseInt(amount) });
        };

        window.deleteOrder = (id, nama) => {
            if (confirm(`Hapus data ${nama}?`)) {
                const pass = prompt(`Ketik "delete" untuk menghapus:`);
                if (pass && pass.toLowerCase() === "delete") {
                    remove(ref(db, 'orders/' + id));
                }
            }
        };
    </script>
</body>
</html>
